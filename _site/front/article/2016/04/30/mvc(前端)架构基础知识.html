<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MVC(前端)架构基础知识</title>
  <meta name="description" content="讲述 MVC 的基础知识和主要前端框架的 MVC 思想，进阶分析一下几个框架渲染原理">

  <link rel="stylesheet" href="/stylesheets/stylesheet.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://bystep15.github.io//front/article/2016/04/30/mvc(%E5%89%8D%E7%AB%AF)%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">
  <link rel="alternate" type="application/rss+xml" title="宝宝树前端团队" href="http://bystep15.github.io//feed.xml">
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
</head>


  <body>

    <header class="main-header">
    <div class="inner">
        <h1>宝宝树前端团队博客</h1>
        <h2>Bystep15.GitHub.io</h2>
        <a href="https://github.com/bystep15" class="button"><small>Follow me on</small> GitHub</a>
    </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <nav>当前位置：<a href="/">首页</a> &gt; <a href="/front/article/2016/04/30/mvc(%E5%89%8D%E7%AB%AF)%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">MVC(前端)架构基础知识</a></nav>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">MVC(前端)架构基础知识</h1>
    <p class="post-meta"><time datetime="2016-04-30T20:02:01+08:00" itemprop="datePublished">Apr 30, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">尹洁</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="mvc-">MVC 架构简介</h1>

<blockquote>
  <p>MVC 是一个软件框架模式。自从 1982 被提出至今，MVC 一直存在于软件行业的各个领域，
为整个软件的基础架构设计、层级设计、模块划分、代码组织逻辑等等行为提供有力的理论支持</p>
</blockquote>

<h2 id="section">知识背景</h2>

<p>上世纪 80 年代初，全球图形界面软件快速发展，在软件规模不断变大的情况下，需要一种明确的软件框架模式对大中型软件进行合理规划。
Xerox PARC 提出了 <strong>模型－视图－控制器（MVC）</strong> 模式，进行框架层级的划分和代码上的分离。</p>

<p><img src="/images/mvc/1.png" alt="MVC frame" /></p>

<p>MVC 提出后被各个图形软件广泛采用。因其具有清晰的逻辑层次和优秀的工程管理性质，被企业软件巨头之一的 Oracle 用在了 J2EE 平台软件的设计模式上。
随着 J2EE 的兴盛和软件面向对象设计的普通采用，MVC 的思想在软件各个领域都大放异彩。</p>

<h2 id="section-1">框架思想哲理</h2>

<blockquote>
  <p>写书是人类表达和展示自己的思想的重要方式</p>
</blockquote>

<p>在老老年间，古人们写书或复制书就只能用手写，直接将字手写在纸上。数据的来源和展现都通过纸面这唯一中间过程。行为不可完全复制。</p>

<p><img src="/images/mvc/2.jpg" alt="MVC frame" /></p>

<p>后来，活字印刷术的出现将上述过程进行统一标准化。将整个过程划分为三部分：</p>

<p><img src="/images/mvc/3.jpg" alt="MVC frame" /></p>

<ul>
  <li>统一的、持久化的数据源：活字 （Model）;</li>
  <li>标准化的业务逻辑过程：排版 （Controller）;</li>
  <li>纯粹的渲染展示：印刷 （View）;</li>
</ul>

<p>如此一来，整个印刷过程根据侧重点的不同分为三部分。每一部分在业务上能够做到相对独立，复用程度提高，后期的维护也简单不少。</p>

<p>MVC 的思想其实在我们生活的各个方面都有展现。将普通作业进行工程化改造，有利于作业过程管理，思维上更加清晰明确。提高工作效率和后期维护度。</p>

<p><img src="/images/mvc/lichen.png" alt="MVC frame" /></p>

<h2 id="mvc--1">主流前端框架的 MVC 简要分析</h2>

<p>下面，以 <code class="highlighter-rouge">backbone</code>、 <code class="highlighter-rouge">angularjs 1</code>、 <code class="highlighter-rouge">reactjs</code> 为例，简要说明一下当 MVC 做为前端的一个新兴的事物，是如何被我们所利用的。</p>

<hr />

<h3 id="backbone">Backbone</h3>

<p>Backbone 框架是三者中最简练，但是最标准的 MVC 前端框架。</p>

<h4 id="section-2">基本特性</h4>

<p><img src="/images/mvc/backbone.png" alt="MVC frame" /></p>

<p>backbone 的中文字面翻译叫 “脊椎” 。如其名，它本是框架特性就是提供了一个明确的结构划分，有良好的扩展性，没有添加过多的“自动化”方法。强依赖 <code class="highlighter-rouge">Underscore</code> 、<code class="highlighter-rouge">jquery</code>/<code class="highlighter-rouge">zepto</code>，从中你可以使用依赖库所提供的方法，比如<code class="highlighter-rouge">this._</code>、<code class="highlighter-rouge">this.$</code>。</p>

<blockquote>
  <p>注意：在 backbone 类的内部调用 jquery：<code class="highlighter-rouge">this.$</code> 有 dom 控制域的限制，这也许被很多刚开始接触的人认为这是一个坑，实际上这个限制正是 backbone 在模块划分上的一种规范，backbone 建议由此来限制用户在控制器内只对 <code class="highlighter-rouge">el</code> 中指定的 dom 元素进行操作，强制用户进行更好的模块划分。</p>
</blockquote>

<p>你会发现上图中缺少 “视图” 元素，这也体现了 backbone 的灵活性，它没有自带的模板引擎，你可以使用依赖库 <code class="highlighter-rouge">Underscore</code> 的 <code class="highlighter-rouge">_.template("———模板内容———")</code> 作为模板引擎，也可以使用其它的模板引擎。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="na">el</span><span class="p">:</span> <span class="s1">'#appele'</span><span class="p">,</span>
    <span class="na">template</span><span class="p">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">'&lt;p&gt;这是一个模板内容&lt;br&gt;&lt;span style="font-size: 30px;"&gt;&lt;%=value%&gt;&lt;/span&gt;&lt;/p&gt;'</span><span class="p">),</span>
    <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Model</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">render</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span><span class="na">value</span><span class="p">:</span> <span class="s1">'哈哈'</span><span class="p">}));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.dom'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>
</div>

<h4 id="section-3">（视图）模板渲染原理</h4>

<p>backbone 是弱单向的数据绑定框架，你只能手动的将所需的数据事件绑定到指定的 Model 上，完全没有视图端的数据变化监听，也不去管数据变化后视图怎么变。它把 render 方法抛给了用户，完全由用户决定怎么弄。<br />
backbone 官方实际引导大家使用一个 简单、粗暴、有成效 的方式，就是 <strong>整个重新渲染</strong> ，而不是“细致”的根据变化的数据来去操作 DOM 一个一个的改。<br />
这实际也是 MVC 的一个核心思想：<strong>数据驱动</strong> — 用户不应该直接操作视图，应该把重心放到数据和业务逻辑上来。</p>

<blockquote>
  <p>注：<strong>整个重新渲染</strong> 在很多情况下并不粗暴，也是有性能考虑的根据的，dom 的频繁改动是页面性能的一个痛点，与其改10个，不如一次换1个，除非你能做到极致。</p>
</blockquote>

<hr />

<h3 id="reactjs">reactjs</h3>

<p>reactjs PS: 我在这里是充数的，其实，我只是个 UI 。</p>

<blockquote>
  <p>JUST THE UI<br />
Lots of people use React as the V in MVC. Since React makes no assumptions about the rest of your technology stack, it’s easy to try it out on a small feature in an existing project.</p>
</blockquote>

<h4 id="section-4">基本特征</h4>

<p>如果说 “正规” 的 MVC 概念重心是进行层级的横向划分，那么 reactjs 的核心概念 Component 则提供一种(页面)模块的纵向划分思想。</p>

<p><img src="/images/mvc/vh.png" alt="v or h" /></p>

<blockquote>
  <p>“横向划分”与“纵向划分”（“水平拆分”与“垂直拆分”）是软件设计的两种最基本思想，相互补充，最终向整个软件系统“组模式”进化。</p>
</blockquote>

<p>举个例子，大家手头有这样一个页面</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        ...<span class="c">&lt;!-- 此处省去50行 and 其它页面也用--&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    
    <span class="nt">&lt;aside&gt;</span>
        ...<span class="c">&lt;!-- 此处省去300行 --&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
    
    <span class="nt">&lt;section&gt;</span>
        ...<span class="c">&lt;!-- 此处省去500行 --&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    
    <span class="nt">&lt;footer&gt;</span>
        ...<span class="c">&lt;!-- 此处省去30行 and 其它页面也用 --&gt;</span>
    <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre>
</div>

<p>这么“庞大”的一个页面，你会怎么分隔，也许你会说，可以用 php 把它折开啊~那么用前端的技术和方法呢？</p>

<blockquote>
  <p>其实，php 和 java 的一些模板引擎早已做到这一步了，而且有着很好的实用性。现在需要用前端的技术完成“前端”的工作。</p>
</blockquote>

<p>现在有了 react 提供的页面组件化方式，你就不用把这么繁多的标签挤在一个页面里了。你的入口主页真的会变成这样:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;MyHeader</span> <span class="nt">/&gt;</span>
    
    <span class="nt">&lt;MyAside</span> <span class="nt">/&gt;</span>
    
    <span class="nt">&lt;MySection</span> <span class="nt">/&gt;</span>
    
    <span class="nt">&lt;MyFooter</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre>
</div>

<p>你只需要在主页面（JS）中 “引入” 每一块的的 JS ，就是会得到你想要的结果，页面包含完整的功能与样式哦。就像这样:</p>

<p><strong>index.jsx</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">//react</span>
<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="c1">//各个页面模块</span>
<span class="kr">import</span> <span class="nx">MyHeader</span> <span class="nx">from</span> <span class="s1">'./MyHeader'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MyAside</span> <span class="nx">from</span> <span class="s1">'./MyAside'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MySection</span> <span class="nx">from</span> <span class="s1">'./MySection'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MyFooter</span> <span class="nx">from</span> <span class="s1">'./MyFooter'</span><span class="p">;</span>
<span class="c1">//整体需要的样式</span>
<span class="kr">import</span> <span class="s1">'./style/reset.less'</span><span class="p">;</span>
<span class="kr">import</span> <span class="s1">'./style/layout.less'</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Index</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nx">MyHeader</span> <span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nx">MyAside</span> <span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nx">MySection</span> <span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nx">MyFooter</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Index</span><span class="p">;</span>
</code></pre>
</div>

<p><strong>mySection.jsx</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">//react</span>
<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="c1">//MySection 模块中需要的样式</span>
<span class="kr">import</span> <span class="s1">'./style/my_section.less'</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MySection</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">&lt;</span><span class="nx">section</span><span class="o">&gt;</span>
                <span class="p">...</span><span class="c">&lt;!--</span> <span class="err">此处省去</span><span class="mi">500</span><span class="err">行</span> <span class="o">--&gt;</span>
            <span class="o">&lt;</span><span class="sr">/section</span><span class="err">&gt;
</span>        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">MySection</span><span class="p">;</span>
</code></pre>
</div>

<p>通过 react 制作的每一个模块都是独立的，你不用再去纠结一个模块的 HTML结构、样式、JS脚本怎么分别弄进来，webpack 的强大的打包能力最终生成的文件肯定让你满意—当然这得自己去配置。</p>

<h4 id="mvc--2">MVC 特性</h4>

<p>从总体框架上来看，虽说 react 不是一个 MVC 框架，但其内在方法的划分和设计原理还是有明显的 MVC 思想。</p>

<p><strong>state</strong> 和 <strong>render</strong>。react 在数据和视图的关系上采用单向数据绑定的数据驱动模式，也就是数据模型和视图是一一对应的，不过数据改动后视图不一定立刻跟着变化，而是需要你自发的用 <strong>setState</strong> 去触发视图内容更新。</p>

<p>但是 react 不像 backbone 那么懒，把渲染视图的过程也抛给用户，react 有自己的一套非常先进的视图渲染系统—基于虚拟 dom 的最少改动方案。大致过程如下图：</p>

<p><img src="/images/mvc/v-dom.png" alt="react 虚拟 DOM" /></p>

<blockquote>
  <p>注：策略上的区别对待是看 dom 更新的情况来确定是重新刷一遍、修改内容、还是替换等</p>
</blockquote>

<h4 id="section-5">渲染的优化点</h4>

<ul>
  <li>将只是内在用的、和视图无关的标识变量不要放在 state 下；</li>
  <li>连续多次的修改 state 下的数据时，可以前几步用直接赋值：
  如：this.state.data = ‘new data’
  最后再统一调起 setState，如：this.setState(data: xxx)</li>
  <li>尽可能的给每一个数组型的 dom 元素定死一个持久化的、唯一的 key，不要用随机值、遍历的 index 等不稳定的值；</li>
  <li>精确控制 shouldComponentUpdate 和 componentWillUpdate，帮助 react 进行过滤。</li>
</ul>

<p>相比 backbone reactjs 就是算是把“DOM 操作”精细化到极致的人，我们最终看到的页面上的东西，不是完全真实的，而存在在内存里的 虚拟DOM 某种意义上才是和你的数据模型完全对应的 dom。</p>

<hr />

<h3 id="angular">angular</h3>

<p>angular 框架是三者中最大，当然也是最 “强” 的 MVC 前端框架。</p>

<h4 id="section-6">基本特性</h4>

<p>angular 本质上是一个 MVVM 框架，也就是 <strong>数据模型-视图</strong> 双向绑定框架，自己就能提供框架所需的全部功能，当然你也可以再加入其它 js 类库，不过那之前我建议你还是先去认真找一找 angular 是否已经有了 -_-。</p>

<p>从 MVC 的基本要点出发，这里简要说一下以下几种模块类型：</p>

<p><img src="/images/mvc/angular.png" alt="angular" /></p>

<p>为了让大家大致了解各部分是干什么的，先说一下任何一个 WEB 应用框架的主要流程大概都是这样的：</p>

<p><img src="/images/mvc/web-app.png" alt="angular" /></p>

<blockquote>
  <p>在这里又要吐糟一下了，Js 总体来说，要比一些成熟的面向对象语言要弱的多，不论从前端框架还是整个 JS 语言的进化来看，都是在不断的追随着如 JAVA、C 等高级语言</p>
</blockquote>

<p>这样，我们从路由 ROUTER 入手，来一步步简要分析一下 angular。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'my_mvc'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'ngRoute'</span><span class="p">,</span> <span class="s1">'ngResource'</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="s1">'use strict'</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">routeConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">controller</span><span class="p">:</span> <span class="s1">'IndexController'</span><span class="p">,</span>       <span class="c1">//对应的 Controller</span>
        <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'js/views/index.html'</span><span class="p">,</span>  <span class="c1">//对应的 html View </span>
        <span class="na">resolve</span><span class="p">:</span> <span class="p">{</span>                           <span class="c1">//获取所需的 Model 操作对象 </span>
            <span class="na">store</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFactory</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//获取数据源</span>
                <span class="k">return</span> <span class="nx">dataFactory</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">module</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> <span class="c1">// Fetch the todo records in the background.</span>
                    <span class="k">return</span> <span class="nx">module</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">$routeProvider</span>
        <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">routeConfig</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">otherwise</span><span class="p">({</span>
            <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span>
        <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
</div>

<p>在路由中，angular 就对 controller 、view、model 进行了明确的组装。
下面就来看看 controller、model 是怎么编写的。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * 控制器 IndexController
 */</span>
<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'my_mvc'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'IndexController'</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">IndexController</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span> <span class="p">{</span>
    <span class="s1">'use strict'</span><span class="p">;</span>
    
    <span class="c1">//从 service 里取数据操作对象</span>
    <span class="kd">var</span> <span class="nx">datalist</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">datalist</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">;</span>
    <span class="c1">//====为了测试用</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">datalist</span> <span class="o">=</span> <span class="nx">datalist</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">$apply</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">;</span>
    
    <span class="c1">//计算数组元素的个数，并进行及时的监控</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">datalist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="s1">'datalist'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">datalist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
    
    <span class="cm">/*
     * 给页面提供的方法
     */</span>
    <span class="c1">//年龄加一</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">_addAge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">age</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">store</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">//加一条记录</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">_insertData</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">id</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'小王'</span> <span class="o">+</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">19</span> <span class="o">+</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">count</span>
        <span class="p">};</span>
        <span class="nx">store</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">_data</span><span class="p">);</span>
    <span class="p">}</span>
    
<span class="p">});</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * 业务逻辑层 dataFactory
 * 这里用了 factory 的封装形式
 */</span>
<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'my_mvc'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'dataFactory'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$http</span><span class="p">,</span> <span class="nx">$injector</span><span class="p">)</span> <span class="p">{</span>
        <span class="s1">'use strict'</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http//localhost/api'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">success</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">$injector</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
                <span class="p">},</span> <span class="kd">function</span> <span class="nx">error</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">$injector</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'localStorage'</span><span class="p">);</span>
                <span class="p">})</span>
    
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'http'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$resource</span><span class="p">)</span> <span class="p">{</span>
        <span class="s1">'use strict'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">datalist</span><span class="p">:</span> <span class="p">[],</span>
            <span class="c1">//用$resource构造 restful API 的 http 的远程接口</span>
            <span class="na">api</span><span class="p">:</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">'http//localhost/api/data/:id'</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">update</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'PUT'</span><span class="p">}}),</span>
            <span class="c1">//数据操作方法</span>
            <span class="na">get</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
				<span class="p">});</span>
			<span class="p">},</span>
            <span class="na">edit</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="nx">data</span><span class="p">)</span>
					<span class="p">.</span><span class="nx">$promise</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="na">insert</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">realData</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

				<span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span>
					<span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
						<span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
					<span class="p">},</span> <span class="kd">function</span> <span class="nx">error</span><span class="p">()</span> <span class="p">{</span>
						<span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">realData</span><span class="p">,</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
					<span class="p">})</span>
					<span class="p">.</span><span class="nx">$promise</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">store</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'localStorage'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>
        <span class="s1">'use strict'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">LOCALSTORAGE_ID</span> <span class="o">=</span> <span class="s1">'my_mvc'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">datalist</span><span class="p">:</span> <span class="p">[],</span>
            <span class="c1">//通过的从 localstorage 存取数据的方法</span>
            <span class="na">_getFromLocalStorage</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">LOCALSTORAGE_ID</span><span class="p">)</span> <span class="o">||</span> <span class="s1">'[]'</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="na">_saveToLocalStorage</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">datalist</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">LOCALSTORAGE_ID</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">datalist</span><span class="p">));</span>
            <span class="p">},</span>
            <span class="c1">//数据操作方法</span>
            <span class="na">get</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
				<span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">_getFromLocalStorage</span><span class="p">(),</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
				<span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
				<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="na">edit</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">(),</span>
                    <span class="nx">i</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
                <span class="nx">store</span><span class="p">.</span><span class="nx">_saveToLocalStorage</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="na">insert</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
                <span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="nx">store</span><span class="p">.</span><span class="nx">_saveToLocalStorage</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
                <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">datalist</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
            <span class="p">}</span>
            
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">store</span><span class="p">;</span>
    <span class="p">})</span>
</code></pre>
</div>

<p>这里要专门说一下 angular 的 service 层。做为一个前端框架，ng 的 service 层异常强大，直接把后台常用的 service 层概念都搬了过来，而且功能实现的都有模有样的。</p>

<ul>
  <li>支持依赖注入 — $injector (JAVA的一个卖点)</li>
  <li>支持 restful 的接口调用 — $resource</li>
  <li>有三种表达形式 — factory、service、provider</li>
</ul>

<h4 id="angular-">angular 双向绑定机制的简要分析</h4>

<p>Angular 通过 $watch、$apply、$digest 三个内方法来实现两端的监听</p>

<p><strong>$watch</strong> 是 model 数据的变化监听队列</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"mvcapp"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">"data in datalist track by $index"</span> <span class="na">ng-click=</span><span class="s">"_addAge(data)"</span><span class="err">}</span><span class="nt">&gt;</span>
            姓名: , 年龄：
        <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;p&gt;</span>点一下加一岁哦~<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>共有条记录<span class="nt">&lt;button</span> <span class="na">ng-click=</span><span class="s">"_insertData()"</span><span class="nt">&gt;</span>加一条记录<span class="nt">&lt;/button&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/section&gt;</span>
</code></pre>
</div>

<p>每当有 controller 最的变量被“写”到模板里时，就 会在 $watch 里添加一条的监听</p>

<blockquote>
  <p>在说明 $apply、$digest 的功能前，先提问一个问题？
你有没有想过这个问题：
Angular 没有提供类似 get(‘data’)、 setState 的特定方法来在数据变动时视图的更新，而是简单的常规 js 对象赋值就能同步改变视图。<br />
比如：只是这样 data.age = data.age + 1 ，页面里的年龄就加了一岁。
要知道，事件监听只是页面 DOM 才有的东西，单纯 JS 数据可没有事件机制的。</p>
</blockquote>

<p>？？？？？？？？？？？？？？？？？？</p>

<p><strong>Angular content</strong> — 双向绑定背景的重要概念</p>

<p>angular 实际没有直接对数据做出监听（本质上也不可能为到），angular 为自己营造了一个叫angular content 的运行环境，任何 “ng-”自定义事件的触发和带有”ng-”指令的 DOM 变化，都会调起下面要说的 $apply 指令，来进行下一步的更新工作。</p>

<p>在上面的 controller 代码中，<strong>//====为了测试用</strong> 的下面两行，我估意向 window 暴露了两个对象(方法)，当你直接通过 window.datalist 来修改数据时，页面视图是不会发生变化的，因为这个修改没有被 angular content 捕捉到。当你调用一下 window.$apply 时，页面又和数据同步了，因为 $apply 是调起页面渲染的功能。</p>

<p>angular content —&gt; $apply —&gt; $digest 流程如下：</p>

<p><img src="/images/mvc/angular-liuchen.png" alt="angular" /></p>

<h4 id="section-7">渲染的优化点</h4>

<p>…好吧，我只能假装一下有优化点</p>

<p>Angular 双向绑定的 $watch、$apply、$digest 机制比较固化，留给使用自己的改进很少。
其中 ng 的数据监听是重点，为了不漏掉任何一个可能会影响数据变化的情况，angular 生成的 $watch 比模板上能看到的要多，还好 js 的处理速度非常快，表现在页面上不会感觉到慢。（但的确比单向绑定框架更耗资源）</p>

<p>ECMAscript 6 中提到了新的特性 Object.observe 。希望浏览器内核提供原生支持后，双向绑定应该会变得更好。</p>

<hr />

<p>总结：mvc 是一种思想，再优秀的 MVC 框架也不一定写出和符合 MVC 逻辑的代码，当然，即使没有 MVC 框架，也可以写出层级清晰的程序。</p>


  </div>

</article>
<!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="/front/article/2016/04/30/mvc(前端)架构基础知识" data-title="MVC(前端)架构基础知识" data-url="/front/article/2016/04/30/mvc(%E5%89%8D%E7%AB%AF)%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"bystep15"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
<!-- 多说公共JS代码 end -->

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!--<h2 class="footer-heading">宝宝树前端团队</h2>-->

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li><a href="/about/">宝宝树前端团队</a></li>
          <li><a href="mailto:front-end@babytree-inc.com">front-end@babytree-inc.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bystep15"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">bystep15</span></a>

          </li>
          

          
        </ul>
      </div>

    </div>

    <div class="friend-link">
        <div class="friend-title">友情链接</div>
        
            <a href="http://testudy.cc/">
		胡继伟
	    </a>
	
            <a href="https://yj1438.github.io/">
		尹杰
	    </a>
	
            <a href="https://github.com/cnsnake11/blog">
		曹楠
	    </a>
	
            <a href="http://www.jianshu.com/users/b7dc4381aed3/">
		姚琪
	    </a>
	
            <a href="">
		魏莉
	    </a>
	
            <a href="https://wangjiaoxia.github.io/">
		王娇霞
	    </a>
	
            <a href="https://lq1228.github.io/">
		李倩
	    </a>
	
            <a href="http://www.ushtml.com/">
		武明礼
	    </a>
	
            <a href="http://kouyun.me/">
		寇云
	    </a>
	
            <a href="http://brooch.me/">
		郑星宬
	    </a>
	
            <a href="http://zhanyouwei.com/">
		占友伟
	    </a>
	
            <a href="">
		
	    </a>
	
            <a href="">
		
	    </a>
	
    </div>

    <div class="copyright">
      <p>宝宝树前端项目组技术博客，欢迎补充
</p>
    </div>

  </div>

</footer>


  </body>

</html>
